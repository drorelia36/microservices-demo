pipeline {
  agent {
    kubernetes {
      yaml """
apiVersion: v1
kind: Pod
spec:
  serviceAccountName: jenkins
  containers:
  - name: tools
    image: dtzar/helm-kubectl:3.14.4
    command: ["sh", "-c", "cat"]
    tty: true
    volumeMounts:
    - mountPath: "/home/jenkins/agent"
      name: "workspace-volume"
      readOnly: false

  - name: kaniko
    image: gcr.io/kaniko-project/executor:debug
    command: ["sh", "-c", "cat"]
    tty: true
    volumeMounts:
    - name: "workspace-volume"
      mountPath: "/home/jenkins/agent"
      readOnly: false
    - name: gcp-sa
      mountPath: /secret
      readOnly: true

  volumes:
  - name: "workspace-volume"
    emptyDir: {}
  - name: gcp-sa
    secret:
      secretName: gcp-sa-json
"""
    }
  }

  options {
    timestamps()
    disableConcurrentBuilds()
  }

  environment {
    PROJECT_ID = "dror-project-482618"
    REGION     = "europe-west1"
    AR_REPO    = "microservices"

    // ×ž×¡×œ×•×œ B: 3 ×¡×‘×™×‘×•×ª
    DEV_NS     = "onlineboutique-dev"
    STAGE_NS   = "onlineboutique-staging"
    PROD_NS    = "onlineboutique-prod"
  }

  stages {

    stage("Checkout") {
      steps { checkout scm }
    }

    stage("Info") {
      steps {
        container('tools') {
          sh '''
            set -euo pipefail
            echo "BRANCH_NAME=${BRANCH_NAME}"
            echo "CHANGE_ID=${CHANGE_ID:-}"
            echo "GIT_COMMIT=${GIT_COMMIT}"
          '''
        }
      }
    }

    stage("Lint/Test") {
      steps {
        container('tools') {
          sh '''
            set -euo pipefail
            echo "=== Lint/Test ==="

            # ×× make ×§×™×™× - × ×¨×™×¥. ×× ××™×Ÿ/×›×©×œ - × ×“×¢ ×‘×ž×§×•× ×©×”×¤×™×™×¤×œ×™×™×Ÿ ×™×§×¨×•×¡ ×‘×œ×™ ×”×¡×‘×¨
            if [ -f Makefile ]; then
              make lint || (echo "lint failed" && exit 1)
              make test || (echo "test failed" && exit 1)
            else
              echo "No Makefile - skipping lint/test"
            fi

            echo "âœ… CI OK"
          '''
        }
      }
    }

    stage("Build & Push frontend image (main only)") {
      when { branch "main" }
      steps {
        container('kaniko') {
          sh '''
            set -euo pipefail
            export GOOGLE_APPLICATION_CREDENTIALS=/secret/sa.json

            TAG="${GIT_COMMIT:0:7}"
            IMAGE="${REGION}-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/frontend:${TAG}"
            IMAGE_LATEST="${REGION}-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/frontend:main-latest"

            echo "ðŸ—ï¸ Building and pushing:"
            echo " - ${IMAGE}"
            echo " - ${IMAGE_LATEST}"

            /kaniko/executor \
              --context "${WORKSPACE}/src/frontend" \
              --dockerfile "${WORKSPACE}/src/frontend/Dockerfile" \
              --destination "${IMAGE}" \
              --destination "${IMAGE_LATEST}" \
              --cache=true \
              --verbosity=debug

            echo "âœ… Image pushed: ${IMAGE}"
          '''
        }
      }
    }

    stage("Deploy manifests to DEV (main only)") {
      when { branch "main" }
      steps {
        container('tools') {
          sh '''
            set -euo pipefail
            echo "ï¿½ï¿½ Deploying base manifests to DEV namespace: ${DEV_NS}"

            kubectl get ns "${DEV_NS}" >/dev/null 2>&1 || kubectl create ns "${DEV_NS}"

            # ×¤×¨×™×¡×” ×¨××©×•× ×™×ª ×©×œ ×›×œ ×”×ž×™×§×¨×•-×¡×¨×‘×™×¡×™× ×œ-DEV
            kubectl apply -n "${DEV_NS}" -f release/kubernetes-manifests.yaml

            echo "âœ… DEV manifests applied"
          '''
        }
      }
      post {
        failure {
          container('tools') {
            sh '''
              set +e
              echo "âŒ DEV deploy (manifests) failed - diagnostics"
              kubectl -n "${DEV_NS}" get pods -o wide || true
              kubectl -n "${DEV_NS}" get events --sort-by=.lastTimestamp | tail -n 60 || true
            '''
          }
        }
      }
    }

    stage("Deploy frontend image to DEV (main only)") {
      when { branch "main" }
      steps {
        container('tools') {
          sh '''
            set -euo pipefail

            TAG="${GIT_COMMIT:0:7}"
            IMAGE="${REGION}-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/frontend:${TAG}"

            echo "ðŸš€ Updating DEV frontend image to ${IMAGE}"
            kubectl -n "${DEV_NS}" set image deploy/frontend server="${IMAGE}"
            kubectl -n "${DEV_NS}" rollout status deploy/frontend --timeout=600s

            echo "âœ… DEV frontend rolled out"
          '''
        }
      }
      post {
        failure {
          container('tools') {
            sh '''
              set +e
              echo "âŒ DEV frontend rollout failed - diagnostics"
              kubectl -n "${DEV_NS}" get pods -l app=frontend -o wide || true
              kubectl -n "${DEV_NS}" describe deploy frontend || true
              kubectl -n "${DEV_NS}" describe pod -l app=frontend || true
              kubectl -n "${DEV_NS}" get events --sort-by=.lastTimestamp | tail -n 60 || true
            '''
          }
        }
      }
    }

    stage("Promote to STAGING (manual approval)") {
      when { branch "main" }
      steps {
        input message: "Promote this build to STAGING?", ok: "Promote"
        container('tools') {
          sh '''
            set -euo pipefail

            TAG="${GIT_COMMIT:0:7}"
            IMAGE="${REGION}-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/frontend:${TAG}"

            echo "ðŸš€ Promoting to STAGING namespace: ${STAGE_NS}"
            kubectl get ns "${STAGE_NS}" >/dev/null 2>&1 || kubectl create ns "${STAGE_NS}"
            kubectl apply -n "${STAGE_NS}" -f release/kubernetes-manifests.yaml

            kubectl -n "${STAGE_NS}" set image deploy/frontend server="${IMAGE}"
            kubectl -n "${STAGE_NS}" rollout status deploy/frontend --timeout=600s

            echo "âœ… STAGING promoted"
          '''
        }
      }
    }

    stage("Promote to PROD (manual approval)") {
      when { branch "main" }
      steps {
        input message: "Promote this build to PROD?", ok: "Promote"
        container('tools') {
          sh '''
            set -euo pipefail

            TAG="${GIT_COMMIT:0:7}"
            IMAGE="${REGION}-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/frontend:${TAG}"

            echo "ðŸš€ Promoting to PROD namespace: ${PROD_NS}"
            kubectl get ns "${PROD_NS}" >/dev/null 2>&1 || kubectl create ns "${PROD_NS}"
            kubectl apply -n "${PROD_NS}" -f release/kubernetes-manifests.yaml

            kubectl -n "${PROD_NS}" set image deploy/frontend server="${IMAGE}"
            kubectl -n "${PROD_NS}" rollout status deploy/frontend --timeout=600s

            echo "âœ… PROD promoted"
          '''
        }
      }
    }
  }
}

